<div class="large-8 columns services-block">
    <table id="table-provided-services" align="center">
        <thead>
        <tr>
            <th>ID</th>
            <th width="85" data-tooltip class="has-tip prs-th" title="Номер Машины">#</th>
            <th width="100" data-tooltip class="has-tip prs-th" title="Дата проведения тех. обслуживания">Когда</th>
            <th data-tooltip class="has-tip prs-th" title="Тип технического облуживания">Tex. услуга</th>
            <th data-tooltip class="has-tip prs-th" title="Пробег машины в километрах на момент тех. обслуживания">Пробег</th>
            <th width="100" data-tooltip class="has-tip prs-th" title="Мастер выполнявший тех. обслуживани">Мастер</th>
            <th data-tooltip class="has-tip prs-th" title="Дополнительная информация">Заметка</th>
            <th data-tooltip class="has-tip prs-th" title="Напоминание о необходимости провести тех. осмотр после КМ">КМ</th>
            <th width="120" data-tooltip class="has-tip prs-th" title="Напоминание о необходимости провести тех. осмотр после Даты">Дата</th>
            <th class="remind-status-th prs-th">Статус напоминания</th>
        </tr>
        </thead>
        <tbody>
            <?php
            //Create associative car array to store some analytic data
            $cars = array();
            foreach ($client->cars as $car) {
                $cars[$car->regNumber] = new stdClass();
                //Collect Active reminders by date and km to compare and use it for health, issue etc
                $cars[$car->regNumber]->remindKmAlert = 0;
                $cars[$car->regNumber]->remindKmOK = 0;
                $cars[$car->regNumber]->remindDateAlert = 0;
                $cars[$car->regNumber]->remindDateOK = 0;
                foreach ($car->providedServices as $providedService) {
                    echo '<tr>';
                    echo '<td>'.$providedService->id.'</td>';
                    echo '<td>'.$car->regNumber.'</td>';
                    echo '<td class="date-when">'.$providedService->startDate.'</td>';
                    foreach($carServices as $carService) {
                        if($providedService->serviceId == $carService->id) {
                            echo '<td>'.$carService->service.'</td>';
                        }
                    }
                    echo '<td>'.$providedService->milage.'</td>';
                    foreach($employees as $employee) {
                        if($providedService->masterId == $employee->id) {
                            echo '<td>'.$employee->fullname.'</td>';
                        }
                    }
                    echo '<td>'.$providedService->moreInfo.'</td>';

                    //If remindKm set estimate status of alert according to milage, milage date update and daily milage
                    /**
                     * TODO test what will be if remindkm or/and reminddate missing
                     * Fix when same number of alert km and date but in different services
                     * currently only number of KM alert will be shown
                     **/
                    $milageRemind = $providedService->remindKm + $providedService->milage;
                    if($providedService->remindStatus > 0) {
                        if(isset($car->milageDate) && isset($car->dailyMilage)) {
                            if ($car->milageDate > 0 && $car->dailyMilage > 0) {
                                //Get number of days between now and last milage updated
                                $days = round((time() - strtotime($car->milageDate))/86400);
                                //Get estimated km after last milage data update
                                $kmSince = $days*$car->dailyMilage;
                                if ($providedService->remindKm > 0 && ($milageRemind  - ($car->milage + $kmSince)) < 0) {
                                    $kmRemindStatus = "alert";
                                    $cars[$car->regNumber]->remindKmAlert++;
                                } else {
                                    $kmRemindStatus = "success";
                                    $cars[$car->regNumber]->remindKmOK++;
                                }
                            }
                        }
                    } else {
                        $kmRemindStatus = 'secondary';
                    }
                    echo '<td class="km-'.$kmRemindStatus.'">'.$milageRemind.'</td>';
                    if($providedService->remindStatus > 0) {
                        if (time() - strtotime($providedService->remindDate) > 0) {
                            $remindDateStatus = "alert";
                            if ( $kmRemindStatus == "success") {
                                $cars[$car->regNumber]->remindDateAlert++;
                            }
                        } else {
                            $remindDateStatus = "success";
                            if ( $kmRemindStatus == "success") {
                                $cars[$car->regNumber]->remindDateOK++;
                            }
                        }
                    } else {
                        $remindDateStatus = 'secondary';
                    }
                    echo '<td class="date-'.$remindDateStatus.'">';
                    echo $providedService->remindDate.'</td>';
                    echo '<td class="remind-status">'.$providedService->remindStatus.'</td>';
                    echo '</tr>';
                }

            }
            ?>
        </tbody>
    </table>
</div>
<div class="large-4 columns analytics-block">
    <div class="analytics-board">
        <?php
        foreach ($client->cars as $key =>$car) {
            //Create div block per car
            echo '<div class="analytic-data">';
            $car->daysInMaintenance = 0;
            //Calculate total expenses per car
            foreach ($car->providedServices as $providedService) {
                //Calculate days in maintenance per car
                //TODO exclude services accomplished same day (filter,oil,check all same time period)
                if(isset($providedService->finishDate)) {
                    //Check if finishdate not same date of startdate
                    if(strtotime($providedService->finishDate) - strtotime($providedService->startDate) > 0){
                        $car->daysInMaintenance = strtotime($providedService->finishDate) - strtotime($providedService->startDate);
                    }
                }
            }
            echo '<h5 class="label radius secondary car-regnum">'.$car->regNumber.' - '.$car->modelId.'</h5>';
        ?>
        <div class="total-health"><h5>Total Health</h5><span id="car-health" class="label radius success">
                <?php
                //Get health estimation for car according to non accomplished reminders by KM(priority) or date
                //TODO health estimation should be done according to pending service types by their weight
                //ex change filter priority 2 but check engine priority is 4
                //Calculate health by counting all active services by km+date and dividing 100*(kmOK+dateOK)/(km+date)
                $totalReminderNumber = $cars[$car->regNumber]->remindKmOK + $cars[$car->regNumber]->remindKmAlert + $cars[$car->regNumber]->remindDateOK + $cars[$car->regNumber]->remindDateAlert;
                    echo round(100*($cars[$car->regNumber]->remindKmOK + $cars[$car->regNumber]->remindDateOK)/$totalReminderNumber).'%';

                ?></span></div>
        <div class="show-issues"><h5>Issues</h5><span id="issue-status" class="label radius <?php
            if($cars[$car->regNumber]->remindKmAlert == 0 && $cars[$car->regNumber]->remindDateAlert == 0) {
                echo 'secondary';
            } else {
                echo 'alert';
            }
            ?>">
                <?php
                //Get issues estimation for car according to non accomplished reminders by KM(priority) and date
                        echo $cars[$car->regNumber]->remindKmAlert + $cars[$car->regNumber]->remindDateAlert;
                ?></span></div>
        <div class="days-in-maintenance"><h5>Days in Maintenance</h5><span id="days-in-maintenance" class="label radius secondary"><?php echo ($car->daysInMaintenance/86400);?></span></div>
        <?php
            //Close tag for per car block
            echo '</div>';
        } ?>
    </div>
    <div class="client-data">
        <ul class="client-info" data-id="<?php echo $client->info->id;?>" data-update-url="/clients/updateOwn">
            <li><h5 class="label radius secondary"><?php echo $client->info->fullname;?></h5></li>
            <li><?php
                $labelInfoClass = 'label-info';
                echo '<span class="'.$labelInfoClass.'">Phone:</span><span class="contact_phone">'.$client->info->contactPhone;?></span></li>
            <li><?php echo '<span class="'.$labelInfoClass.'">Email:</span><span class="contact_email">'.$client->info->contactEmail;?></span></li>
            <li><?php echo '<span class="'.$labelInfoClass.'">Signup date:</span><span class="date-registration">'.$client->info->regDate;?></span></li>
            <li><?php echo '<span class="'.$labelInfoClass.'">Add info:</span><span class="more_info">'.$client->info->moreInfo;?></span></li>
            <li><?php echo '<span class="'.$labelInfoClass.'">Username:</span>'.$client->info->username;?></li>
            <li><?php echo '<span class="'.$labelInfoClass.'">Notify me :</span><span class="notify">';
                 if ($client->info->notify > 0) {echo 'Yes';} else {echo 'No';};?></span></li>
            <li><span class="password">Change password</span></li>
        </ul>
    </div>
    <div class="car-data">
        <?php
        //Same header car info label class
        foreach ($client->cars as $car) {
            echo ' <ul class="car-info" data-id="'.$car->id.'" data-update-url="/cars/updateOwn">';
            echo '<li><h5 class="label radius secondary">'.$car->modelId.'</h5></li>';
            echo '<li><span class="'.$labelInfoClass.'">Reg. number:</span>'.$car->regNumber.'</li>';
            echo '<li><span class="'.$labelInfoClass.'">Year:</span>'.$car->year.'</li>';
            echo '<li><span class="'.$labelInfoClass.'">First service date:</span>'.$car->regDate.'</li>';
            echo '<li><span class="'.$labelInfoClass.'">Current KM:</span><span class="milage" data-milage_date="'.$car->milageDate.'">'.$car->milage.'</span></li>';
            echo '<li><span class="'.$labelInfoClass.'">Milage KM/day:</span><span class="daily_milage">'.$car->dailyMilage.'</span></li>';
            echo '<li><span class="'.$labelInfoClass.'">Car VIN:</span>'.$car->vin.'</li>';
            echo '<li><span class="'.$labelInfoClass.'">Add info:</span>'.$car->moreInfo.'</li>';
            echo '</ul>';
        }

        ?>
    </div>
</div>

