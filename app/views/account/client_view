<div class="large-8 columns services-block">
    <table id="table-provided-services" align="center">
        <thead>
        <tr>
            <th>ID</th>
            <th width="85" data-tooltip class="has-tip prs-th" title="Номер Машины">#</th>
            <th width="100" data-tooltip class="has-tip prs-th" title="Дата проведения тех. обслуживания">Когда</th>
            <th data-tooltip class="has-tip prs-th" title="Тип технического облуживания">Tex. услуга</th>
            <th data-tooltip class="has-tip prs-th" title="Стоимость тех. облуживания">$</th>
            <th data-tooltip class="has-tip prs-th" title="Пробег машины в километрах на момент тех. обслуживания">Пробег</th>
            <th data-tooltip class="has-tip prs-th" title="Мастер выполнявший тех. обслуживани">Мастер</th>
            <th data-tooltip class="has-tip prs-th" title="Дополнительная информация">Заметка</th>
            <th data-tooltip class="has-tip prs-th" title="Напоминание о необходимости провести тех. осмотр после КМ">КМ</th>
            <th width="100" data-tooltip class="has-tip prs-th" title="Напоминание о необходимости провести тех. осмотр после Даты">Дата</th>
            <th class="remind-status-th prs-th">Статус напоминания</th>
        </tr>
        </thead>
        <tbody>
            <?php
            //Create associative car array to store some analytic data
            $cars = array();
            foreach ($client->cars as $car) {
                $cars[$car->regnum] = new stdClass();
                //Collect Active reminders by date and km to compare and use it for health, issue etc
                $cars[$car->regnum]->remindKmAlert = 0;
                $cars[$car->regnum]->remindKmOK = 0;
                $cars[$car->regnum]->remindDateAlert = 0;
                $cars[$car->regnum]->remindDateOK = 0;
                foreach ($car->providedServices as $providedService) {
                    echo '<tr>';
                    echo '<td>'.$providedService->id.'</td>';
                    echo '<td>'.$car->regnum.'</td>';
                    echo '<td>'.$providedService->startdate.'</td>';
                    foreach($carservices as $carservice) {
                        if($providedService->work_id == $carservice->id) {
                            echo '<td>'.$carservice->carservice.'</td>';
                        }
                    }
                    echo '<td>'.$providedService->cost.'</td>';
                    echo '<td>'.$providedService->milage.'</td>';
                    foreach($employees as $employee) {
                        if($providedService->master_id == $employee->id) {
                            echo '<td>'.$employee->fullname.'</td>';
                        }
                    }
                    echo '<td>'.$providedService->moreinfo.'</td>';

                    //If remindKm set estimate status of alert according to milage, milage date update and daily milage
                    //TODO test what will be if remindkm or/and reminddate missing
                    $milageRemind = $providedService->remindkm + $providedService->milage;
                    if($providedService->remind > 0) {
                        if(isset($car->mlgdate) && isset($car->dailymilage)) {
                            if ($car->mlgdate > 0 && $car->dailymilage > 0) {
                                //Get number of days between now and last milage updated
                                $days = round((time() - strtotime($car->mlgdate))/86400);
                                //Get estimated km after last milage data update
                                $kmSince = $days*$car->dailymilage;
                                if ($providedService->remindkm > 0 && ($milageRemind  - ($car->milage + $kmSince)) < 0) {
                                    $kmRemindStatus = "alert";
                                    $cars[$car->regnum]->remindKmAlert++;
                                } else {
                                    $kmRemindStatus = "success";
                                    $cars[$car->regnum]->remindKmOK++;
                                }
                            }
                        }
                    } else {
                        $kmRemindStatus = 'secondary';
                    }
                    echo '<td class="km-'.$kmRemindStatus.'">'.$milageRemind.'</td>';
                    if($providedService->remind > 0) {
                        if (time() - strtotime($providedService->reminddate) > 0){
                            $remindDateStatus = "alert";
                            $cars[$car->regnum]->remindDateAlert++;
                        } else {
                            $remindDateStatus = "success";
                            $cars[$car->regnum]->remindDateOK++;
                        }
                    } else {
                        $remindDateStatus = 'secondary';
                    }
                    echo '<td class="date-'.$remindDateStatus.'">';
                    echo $providedService->reminddate.'</td>';
                    echo '<td class="remind-status">'.$providedService->remind.'</td>';
                    echo '</tr>';
                }
            }
            ?>
        </tbody>
    </table>
</div>
<div class="large-4 columns analytics-block">
    <div class="analytics-board">
        <?php
        foreach ($client->cars as $key =>$car) {
            //Create div block per car
            echo '<div class="analytic-data">';
            $car->totalExpenses = 0;
            $car->daysInMaintenance = 0;
            //Calculate total expenses per car
            foreach ($car->providedServices as $providedService) {
                $car->totalExpenses += $providedService->cost;
                //Calculate days in maintenance per car
                if(isset($providedService->finishdate)) {
                    //Check if finishdate not same date of startdate
                    if(strtotime($providedService->finishdate) - strtotime($providedService->startdate) > 0){
                        $car->daysInMaintenance = strtotime($providedService->finishdate) - strtotime($providedService->startdate);
                    }
                }
            }
            echo '<h5 class="label radius secondary car-regnum">'.$car->regnum.' - '.$car->model.'</h5>';
            echo '<div class="total-expenses">';
            echo '<h5>Total Expenses</h5><span id="total-cost" class="label radius">'.$car->totalExpenses.' cум</span>';
        ?>
            </div>
        <div class="total-health"><h5>Total Health</h5><span id="car-health" class="label radius success">
                <?php
                //Get health estimation for car according to non accomplished reminders by KM(priority) or date
                //TODO health estimation should be done according to pending service types by their weight
                //ex change filter priority 2 but check engine priority is 4
                if($cars[$car->regnum]->remindKmAlert > $cars[$car->regnum]->remindDateAlert) {
                    echo round(100*$cars[$car->regnum]->remindKmOK/($cars[$car->regnum]->remindKmAlert + $cars[$car->regnum]->remindKmOK)).'%';
                } else {
                    echo round(100*$cars[$car->regnum]->remindDateOK/($cars[$car->regnum]->remindDateAlert + $cars[$car->regnum]->remindDateOK)).'%';
                }
                ?></span></div>
        <div class="show-issues"><h5>Issues</h5><span id="issue-status" class="label radius <?php
            if($cars[$car->regnum]->remindKmAlert == 0 && $cars[$car->regnum]->remindDateAlert == 0) {
                echo 'secondary';
            } else {
                echo 'alert';
            }
            ?>">
                <?php
                //Get issues estimation for car according to non accomplished reminders by KM(priority) or date
                    if($cars[$car->regnum]->remindKmAlert > $cars[$car->regnum]->remindDateAlert) {
                        echo $cars[$car->regnum]->remindKmAlert;
                    } else {
                        echo $cars[$car->regnum]->remindDateAlert;
                    }
                ?></span></div>
        <div class="days-in-maintenance"><h5>Days in Maintenance</h5><span id="days-in-maintenance" class="label radius secondary"><?php echo ($car->daysInMaintenance/86400);?></span></div>
        <?php
            //Close tag for per car block
            echo '</div>';
        } ?>
    </div>
    <div class="client-data">
        <ul class="client-info" data-id="<?php echo $client->info->id;?>" data-update-url="/clients/updateOwn">
            <li><h5 class="label radius secondary"><?php echo $client->info->fullname;?></h5></li>
            <li><?php
                $labelInfoClass = 'label-info';
                echo '<span class="'.$labelInfoClass.'">Phone:</span><span class="contactphone">'.$client->info->contactphone;?></span></li>
            <li><?php echo '<span class="'.$labelInfoClass.'">Email:</span><span class="contactemail">'.$client->info->contactemail;?></span></li>
            <li><?php echo '<span class="'.$labelInfoClass.'">Signup date:</span>'.$client->info->regdate;?></li>
            <li><?php echo '<span class="'.$labelInfoClass.'">Add info:</span><span class="moreinfo">'.$client->info->moreinfo;?></span></li>
            <li><?php echo '<span class="'.$labelInfoClass.'">Username:</span>'.$client->info->username;?></li>
            <li><span class="password" data-updatable="yes">Change password</span></li>
        </ul>
    </div>
    <div class="car-data">
        <?php
        //Same header car info label class
        foreach ($client->cars as $car) {
            echo ' <ul class="car-info" data-id="'.$car->id.'" data-update-url="/cars/updateOwn">';
            echo '<li><h5 class="label radius secondary">'.$car->model.'</h5></li>';
            echo '<li><span class="'.$labelInfoClass.'">Reg. number:</span>'.$car->regnum.'</li>';
            echo '<li><span class="'.$labelInfoClass.'">Year:</span>'.$car->year.'</li>';
            echo '<li><span class="'.$labelInfoClass.'">First service date:</span>'.$car->regdate.'</li>';
            echo '<li><span class="'.$labelInfoClass.'">Current KM:</span><span class="milage" data-mlgdate="'.$car->mlgdate.'">'.$car->milage.'</span></li>';
            echo '<li><span class="'.$labelInfoClass.'">Milage KM/day:</span><span class="dailymilage">'.$car->dailymilage.'</span></li>';
            echo '<li><span class="'.$labelInfoClass.'">Body number:</span>'.$car->bodynumber.'</li>';
            echo '<li><span class="'.$labelInfoClass.'">Engine number:</span>'.$car->enginenumber.'</li>';
            echo '<li><span class="'.$labelInfoClass.'">Add info:</span>'.$car->moreinfo.'</li>';
            echo '</ul>';
        }

        ?>
    </div>
</div>

